<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="tilt.company.match">
<title>Get started (code) • tilt.company.match</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Get started (code)">
<meta property="og:description" content="tilt.company.match">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">tilt.company.match</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9002</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/tilt-company-match.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/README_code.html">README (code)</a>
    <a class="dropdown-item" href="../articles/standalone.html">Standalone (code)</a>
    <a class="dropdown-item" href="../articles/tilt-company-match_code.html">Get started (code)</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Get started (code)</h1>
            
      
      
      <div class="d-none name"><code>tilt-company-match_code.Rmd</code></div>
    </div>

    
    
<p>This article is identical to “Get started” but the text is commented
out so you can copy-paste and run it as a single .R script.</p>
<pre><code><span><span class="co">#' ---</span></span>
<span><span class="co">#' title: "tilt.company.match"</span></span>
<span><span class="co">#' ---</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">## ---- include = FALSE---------------------------------------------------------</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/knitr/man/opts_chunk.html" class="external-link">opts_chunk</a></span><span class="op">$</span><span class="fu">set</span><span class="op">(</span></span>
<span>  collapse <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  comment <span class="op">=</span> <span class="st">"#&gt;"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' This document explains how to match companies in a loanbook from a bank to</span></span>
<span><span class="co">#' companies in a tilt dataset from 2 Degrees Investing Initiative.</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' ## Considerations</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' * The company's name may be different in each dataset, for example because of typos.</span></span>
<span><span class="co">#' * The company's country and postcode are useful. A match by name, country, and postcode is more</span></span>
<span><span class="co">#' reliable than a match by name alone.</span></span>
<span><span class="co">#' * The company may not exist in the tilt dataset.</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' ## Data requirements</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' Both your loanbook and tilt dataset must meet these requirements:</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' * It's an R dataframe.</span></span>
<span><span class="co">#' * It has the columns `id`, `company_name`, `postcode`, and `country`.</span></span>
<span><span class="co">#' * It may or may not have other columns.</span></span>
<span><span class="co">#' * The column `id` holds unique row-identifiers.</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' ## System requirements</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' * [Install R and RStudio](https://happygitwithr.com/install-r-rstudio.html).</span></span>
<span><span class="co">#' * [Setup an R build toolchain](https://r-pkgs.org/setup.html#setup-tools).</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' ## 1. In R (session 1)</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' In this first R session you'll create a dataset with candidate matches for the</span></span>
<span><span class="co">#' companies in your loanbook.</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' ### Install and use R packages</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' You need the package</span></span>
<span><span class="co">#' [tilt.company.match](https://github.com/2DegreesInvesting/tilt.company.match).</span></span>
<span><span class="co">#' You can install it from [r-universe](https://r-universe.dev/) with:</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' ```r</span></span>
<span><span class="co">#' options(repos = c("https://2degreesinvesting.r-universe.dev", getOption("repos")))</span></span>
<span><span class="co">#' install.packages("tilt.company.match")</span></span>
<span><span class="co">#' ```</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' Or you can install it from [GitHub](https://github.com/) with:</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' ``` r</span></span>
<span><span class="co">#' # install.packages("devtools")</span></span>
<span><span class="co">#' devtools::install_github("2DegreesInvesting/tilt.company.match")</span></span>
<span><span class="co">#' ```</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' You'll also use the packages dplyr and stringdist but they install automatically</span></span>
<span><span class="co">#' with tilt.company.match. You can use them all with:</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">## -----------------------------------------------------------------------------</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://vroom.r-lib.org" class="external-link">vroom</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/markvanderloo/stringdist" class="external-link">stringdist</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://2degreesinvesting.github.io/tilt.company.match/">tilt.company.match</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' ### Read the datasets</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' This example uses a "demo" loanbook. You should use your real loanbook instead</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">## -----------------------------------------------------------------------------</span></span>
<span><span class="co"># TODO: Replace with the path/to/your/real/loanbook.csv</span></span>
<span><span class="va">loanbook_csv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/example_file.html">example_file</a></span><span class="op">(</span><span class="st">"demo_loanbook.csv"</span><span class="op">)</span></span>
<span><span class="va">loanbook_csv</span></span>
<span></span>
<span><span class="va">loanbook</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://vroom.r-lib.org/reference/vroom.html" class="external-link">vroom</a></span><span class="op">(</span><span class="va">loanbook_csv</span>, show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">loanbook</span></span>
<span></span>
<span><span class="co"># TODO: Replace with the path/to/your/real/tilt.csv</span></span>
<span><span class="va">tilt_csv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/example_file.html">example_file</a></span><span class="op">(</span><span class="st">"demo_tilt.csv"</span><span class="op">)</span></span>
<span><span class="va">tilt_csv</span></span>
<span></span>
<span><span class="va">tilt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://vroom.r-lib.org/reference/vroom.html" class="external-link">vroom</a></span><span class="op">(</span><span class="va">tilt_csv</span>, show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">tilt</span></span>
<span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' ### Check data quality</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' Let's first check you `loanbook` is as we expect.</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' #### Expected columns</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' Do you have the expected columns `id`, `company_name`, `postcode`, and `country`?</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">## -----------------------------------------------------------------------------</span></span>
<span><span class="va">expected</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"company_name"</span>, <span class="st">"postcode"</span>, <span class="st">"country"</span><span class="op">)</span></span>
<span><span class="va">loanbook</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/check_crucial_names.html">check_crucial_names</a></span><span class="op">(</span><span class="va">expected</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Anything different throws an error</span></span>
<span><span class="va">bad</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span><span class="va">loanbook</span>, ids <span class="op">=</span> <span class="va">id</span><span class="op">)</span></span>
<span><span class="va">bad</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/check_crucial_names.html">check_crucial_names</a></span><span class="op">(</span><span class="va">expected</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' #### Duplicates</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' Do you have any duplicates in the column `id`?</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">## -----------------------------------------------------------------------------</span></span>
<span><span class="va">has_no_duplicates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html" class="external-link">anyDuplicated</a></span><span class="op">(</span><span class="va">loanbook</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>, <span class="fl">0L</span><span class="op">)</span></span>
<span><span class="co"># If you get an error, remove the duplicates and try again</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="va">has_no_duplicates</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' Do you have duplicates in `company_name`, `postcode` or `country`?</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' It's best if there is none. But if you find duplicates and they belong to</span></span>
<span><span class="co">#' different companies, then you don't have to fix them.</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">## -----------------------------------------------------------------------------</span></span>
<span><span class="va">best_without_duplicates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"company_name"</span>, <span class="st">"postcode"</span>, <span class="st">"country"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/report_duplicates.html">report_duplicates</a></span><span class="op">(</span><span class="va">loanbook</span>, <span class="va">best_without_duplicates</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' For example, here the column `misc_info` suggests the duplicates belong to</span></span>
<span><span class="co">#' different companies, so it's OK:</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">## -----------------------------------------------------------------------------</span></span>
<span><span class="va">loanbook</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">company_name</span> <span class="op">==</span> <span class="st">"Peasant Peter"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">postcode</span> <span class="op">==</span> <span class="st">"01234"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' #### Missing values</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' Do you have missing values (`NA`s) in non-nullable columns?</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' Non-nullable columns must not have missing values. If they do you have to remove</span></span>
<span><span class="co">#' them. Missing values in other columns are fine.</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">## -----------------------------------------------------------------------------</span></span>
<span><span class="va">non_nullable</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"company_name"</span><span class="op">)</span></span>
<span><span class="va">loanbook</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/abort_if_incomplete.html">abort_if_incomplete</a></span><span class="op">(</span><span class="va">non_nullable</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' For example, here the non-nullable `id` column has one missing value:</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">## -----------------------------------------------------------------------------</span></span>
<span><span class="va">bad_loanbook</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">id</span>, <span class="op">~</span><span class="va">company_name</span>, <span class="op">~</span><span class="va">postcode</span>, <span class="op">~</span><span class="va">country</span>, <span class="op">~</span><span class="va">misc_info</span>,</span>
<span>  <span class="cn">NA</span>, <span class="st">"John Meier's Groceries"</span>, <span class="st">"55555"</span>, <span class="st">"germany"</span>, <span class="st">"Y"</span>,</span>
<span>  <span class="fl">11</span>, <span class="st">"John Meier's Groceries"</span>, <span class="st">"55555"</span>, <span class="st">"norway"</span>, <span class="st">"Y"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">bad_loanbook</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/abort_if_incomplete.html">abort_if_incomplete</a></span><span class="op">(</span><span class="va">non_nullable</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fixed_loanbook</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">bad_loanbook</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># NA's are OK in columns other than non-nullable ones</span></span>
<span><span class="va">fixed_loanbook</span></span>
<span></span>
<span><span class="va">fixed_loanbook</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/abort_if_incomplete.html">abort_if_incomplete</a></span><span class="op">(</span><span class="va">non_nullable</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' ### Create a standard alias of `company_name` in both datasets</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' Use `to_alias()` to reduce the chance you'll miss a match because of spurious</span></span>
<span><span class="co">#' differences in the company name between the loanbook and tilt dataset. This</span></span>
<span><span class="co">#' helps you get a less noisy, more consistent version of `company_name` in each of</span></span>
<span><span class="co">#' the two datasets.</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">## -----------------------------------------------------------------------------</span></span>
<span><span class="va">loanbook_alias</span> <span class="op">&lt;-</span> <span class="va">loanbook</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>company_alias <span class="op">=</span> <span class="fu"><a href="../reference/to_alias.html">to_alias</a></span><span class="op">(</span><span class="va">company_name</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">loanbook_alias</span></span>
<span></span>
<span><span class="va">tilt_alias</span> <span class="op">&lt;-</span> <span class="va">tilt</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>company_alias <span class="op">=</span> <span class="fu"><a href="../reference/to_alias.html">to_alias</a></span><span class="op">(</span><span class="va">company_name</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">tilt_alias</span></span>
<span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' ### Match candidates</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' To inform the decision about which companies in your `loanbook` match companies in the `tilt`</span></span>
<span><span class="co">#' dataset, we compare the values in the columns `postcode` and `country`:</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' * If your `loanbook` has both `postcode` and `country` we match companies in that specific `postcode` and that specific `country`. You will likely match companies that are really the same (true positives) because it's unlikely that two companies with similar name will be located close to each other. This will cost you the minimum amount of manual-validation work ahead.</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">## -----------------------------------------------------------------------------</span></span>
<span><span class="va">lacks_none</span> <span class="op">&lt;-</span> <span class="va">loanbook_alias</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">postcode</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">country</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">tilt_alias</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"country"</span>, <span class="st">"postcode"</span><span class="op">)</span>,</span>
<span>    suffix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">""</span>, <span class="st">"_tilt"</span><span class="op">)</span>,</span>
<span>    multiple <span class="op">=</span> <span class="st">"all"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' * If your `loanbook` lacks `postcode` but has `country` we match companies in that specific `country` but across every `postcode`. You will possibly match companies that are not really</span></span>
<span><span class="co">#' the same (false positives) but happen to have a similar name and are located in</span></span>
<span><span class="co">#' the same `country`. This will cost you additional manual-validation work ahead.</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">## -----------------------------------------------------------------------------</span></span>
<span><span class="va">lacks_postcode</span> <span class="op">&lt;-</span> <span class="va">loanbook_alias</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">postcode</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">country</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span></span>
<span>    <span class="va">tilt_alias</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"country"</span><span class="op">)</span>,</span>
<span>    suffix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">""</span>, <span class="st">"_tilt"</span><span class="op">)</span>,</span>
<span>    multiple <span class="op">=</span> <span class="st">"all"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' * If your `loanbook` has `postcode` but lacks `country` we match companies with the same `postcode` but  across every `country`. You will possibly match companies that are not really</span></span>
<span><span class="co">#' the same (false positives) but happen to have a similar name and the same</span></span>
<span><span class="co">#' postcode. This will cost you additional manual-validation work ahead.</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">## -----------------------------------------------------------------------------</span></span>
<span><span class="va">lacks_country</span> <span class="op">&lt;-</span> <span class="va">loanbook_alias</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">postcode</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">country</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">tilt_alias</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"postcode"</span><span class="op">)</span>, suffix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">""</span>, <span class="st">"_tilt"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' * If your `loanbook` lacks both `postcode` and `country` we match companies across the entire dataset.  You will most likely match companies that are not really</span></span>
<span><span class="co">#' the same (false positives). This will cost you the greatest amount of additional</span></span>
<span><span class="co">#' manual-validation work ahead.</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">## -----------------------------------------------------------------------------</span></span>
<span><span class="va">lacks_both</span> <span class="op">&lt;-</span> <span class="va">loanbook_alias</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">postcode</span><span class="op">)</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">country</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>postcode <span class="op">=</span> <span class="st">"join_helper"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="va">tilt_alias</span>, postcode <span class="op">=</span> <span class="st">"join_helper"</span><span class="op">)</span>,</span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"postcode"</span><span class="op">)</span>,</span>
<span>    suffix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">""</span>, <span class="st">"_tilt"</span><span class="op">)</span>,</span>
<span>    multiple <span class="op">=</span> <span class="st">"all"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>postcode <span class="op">=</span> <span class="cn">NA_character_</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' Having considered all cases, you can now combine them all in a single dataset:</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">## -----------------------------------------------------------------------------</span></span>
<span><span class="va">candidates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">lacks_none</span>, <span class="va">lacks_postcode</span>, <span class="va">lacks_country</span>, <span class="va">lacks_both</span><span class="op">)</span></span>
<span></span>
<span><span class="va">candidates</span></span>
<span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' Above each join allowed any one company in your `loanbook` to match `"all"` of</span></span>
<span><span class="co">#' the potentially `multiple` companies the `tilt` dataset. Here, for example, one</span></span>
<span><span class="co">#' company in our demo `loanbook` matches three candidates in our demo `tilt`</span></span>
<span><span class="co">#' dataset:</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">## -----------------------------------------------------------------------------</span></span>
<span><span class="va">candidates</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">id</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">company_alias</span>, <span class="va">id_tilt</span>, <span class="va">company_alias_tilt</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' Next, calculate the string similarity between the aliased `company_name` from</span></span>
<span><span class="co">#' the loanbook and tilt datasets. Complete similarity corresponds to `1`, and</span></span>
<span><span class="co">#' complete dissimilarity corresponds to `0`. For each company in the loanbook,</span></span>
<span><span class="co">#' arrange matching candidates by descending similarity.</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">## -----------------------------------------------------------------------------</span></span>
<span><span class="va">okay_candidates</span> <span class="op">&lt;-</span> <span class="va">candidates</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Other parameters may perform best. See `?stringdist::stringsim`</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>similarity <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/stringdist/man/stringsim.html" class="external-link">stringsim</a></span><span class="op">(</span></span>
<span>    <span class="va">company_alias</span>, <span class="va">company_alias_tilt</span>,</span>
<span>    <span class="co"># Good to compare human typed text that might have typos.</span></span>
<span>    method <span class="op">=</span> <span class="st">"jw"</span>,</span>
<span>    p <span class="op">=</span> <span class="fl">0.1</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Arrange matching candidates from more to less similar</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">id</span>, <span class="op">-</span><span class="va">similarity</span><span class="op">)</span></span>
<span></span>
<span><span class="va">okay_candidates</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html" class="external-link">relocate</a></span><span class="op">(</span><span class="va">similarity</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' ### Pick best candidates</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">## -----------------------------------------------------------------------------</span></span>
<span><span class="va">eligibility_threshold</span> <span class="op">&lt;-</span> <span class="fl">0.75</span></span>
<span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' Empirically we found that candidates under a `similarity` threshold of </span></span>
<span><span class="co">#' `r eligibility_threshold` are most likely false positives. Pick `similarity`</span></span>
<span><span class="co">#' values above that threshold to drastically reduce the number of candidates</span></span>
<span><span class="co">#' you'll need to validate manually. We believe this benefit outweighs the</span></span>
<span><span class="co">#' potential loss of a few true positives.</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">## -----------------------------------------------------------------------------</span></span>
<span><span class="va">best_candidates</span> <span class="op">&lt;-</span> <span class="va">okay_candidates</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">similarity</span> <span class="op">&gt;</span> <span class="va">eligibility_threshold</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">similarity</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' After picking the best candidates, some companies in your `loanbook` might no</span></span>
<span><span class="co">#' longer have any candidate in the `tilt` dataset.</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">## -----------------------------------------------------------------------------</span></span>
<span><span class="va">unmatched</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html" class="external-link">anti_join</a></span><span class="op">(</span></span>
<span>  <span class="va">okay_candidates</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">company_name</span><span class="op">)</span>,</span>
<span>  <span class="va">best_candidates</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">company_name</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">unmatched</span></span>
<span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' ### Suggest matches</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">## -----------------------------------------------------------------------------</span></span>
<span><span class="co"># Decided upon extensive experience</span></span>
<span><span class="va">suggestion_threshold</span> <span class="op">&lt;-</span> <span class="fl">0.9</span></span>
<span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' Later you'll need to manually decide which of all candidates if any is a true</span></span>
<span><span class="co">#' match. To make that job easier, we can automatically make some suggestions in a</span></span>
<span><span class="co">#' new column `suggest_match`.</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' The values of `suggest_match` are set to `TRUE` where the value of `similarity`</span></span>
<span><span class="co">#' meets all of these conditions:</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' * It's the highest among all other candidates.</span></span>
<span><span class="co">#' * It's above a threshold of `r suggestion_threshold`.</span></span>
<span><span class="co">#' * It's the only such highest value in the group defined by a combination of `company_name` x `postcode` -- to avoid duplicates.</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">## -----------------------------------------------------------------------------</span></span>
<span><span class="va">candidates_suggest_match</span> <span class="op">&lt;-</span> <span class="va">best_candidates</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># - It's the highest among all other candidates.</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">similarity</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">similarity</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># - It's above the threshold.</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">similarity</span> <span class="op">&gt;</span> <span class="va">suggestion_threshold</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># - It's the only such highest value in the group defined by a combination of</span></span>
<span>  <span class="co"># `company_name` x `postcode` -- to avoid duplicates.</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>duplicates <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu"><a href="../reference/duplicated_paste.html">duplicated_paste</a></span><span class="op">(</span><span class="va">company_name</span>, <span class="va">postcode</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">duplicates</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">id_tilt</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>suggest_match <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' In all other rows the value of `suggest_match` is automatically set to `NA`.</span></span>
<span><span class="co">#' Also now create a new column `accept_match` and fill it with `NA`. Later you'll</span></span>
<span><span class="co">#' edit this column.</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">## -----------------------------------------------------------------------------</span></span>
<span><span class="va">to_edit</span> <span class="op">&lt;-</span> <span class="va">best_candidates</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">candidates_suggest_match</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"id_tilt"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>accept_match <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span></span>
<span></span>
<span><span class="va">to_edit</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html" class="external-link">relocate</a></span><span class="op">(</span><span class="va">similarity</span>, <span class="va">suggest_match</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' Note that even a `similarity` of `1` in the same `postcode` can be a false</span></span>
<span><span class="co">#' positive. For example, this is false positive:</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">## -----------------------------------------------------------------------------</span></span>
<span><span class="va">to_edit</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">id</span> <span class="op">==</span> <span class="fl">4</span>, <span class="va">id_tilt</span> <span class="op">==</span> <span class="fl">4</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">suggest_match</span>, <span class="va">similarity</span>, <span class="va">postcode</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">matches</a></span><span class="op">(</span><span class="st">"misc_info"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' Now write the dataset `to_edit` so that you can explore it in a spreadsheet</span></span>
<span><span class="co">#' editor. For example, you may write it as a .csv or .xlsx file then open it in</span></span>
<span><span class="co">#' Excel or GoogleSheets.</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' ```r</span></span>
<span><span class="co">#' vroom::vroom_write(to_edit, "to_edit.csv", delim = ",")</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' # Or, you can install the writexl package with: `install.packages("writexl")`</span></span>
<span><span class="co">#' writexl::write_xlsx(to_edit, "to_edit.xlsx")</span></span>
<span><span class="co">#' ```</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' ## 2. In a spreadsheet editor</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' ### Accept or reject matches</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' * Import the dataset `to_edit` into a spreadsheet editor like Excel or GoogleSheets.</span></span>
<span><span class="co">#' * For each row decide if you want to reject or accept the suggested match. By default</span></span>
<span><span class="co">#' each row is rejected. To accept it type TRUE in the column `accept_match`.</span></span>
<span><span class="co">#' * Save the edited file to later use it again in R, for example e.g. as "edited.csv".</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' ## 3. In R (session 2)</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' ### Use R packages and read data </span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' Restart R to ensure nothing from the previous R session affects this one.</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' Use the required packages for this section.</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">## -----------------------------------------------------------------------------</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://2degreesinvesting.github.io/tilt.company.match/">tilt.company.match</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' Read the "edited.csv" file, and again your loanbook.</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">## -----------------------------------------------------------------------------</span></span>
<span><span class="co"># TODO: Replace with the path/to/your/real/edited.csv</span></span>
<span><span class="va">edited_csv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/example_file.html">example_file</a></span><span class="op">(</span><span class="st">"demo_matched.csv"</span><span class="op">)</span></span>
<span><span class="va">edited_csv</span></span>
<span></span>
<span><span class="va">edited</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://vroom.r-lib.org/reference/vroom.html" class="external-link">vroom</a></span><span class="op">(</span><span class="va">edited_csv</span>, show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">edited</span></span>
<span></span>
<span><span class="co"># TODO: Replace with the path/to/your/real/loanbook.csv</span></span>
<span><span class="va">loanbook_csv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/example_file.html">example_file</a></span><span class="op">(</span><span class="st">"demo_loanbook.csv"</span><span class="op">)</span></span>
<span><span class="va">loanbook_csv</span></span>
<span></span>
<span><span class="va">loanbook</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://vroom.r-lib.org/reference/vroom.html" class="external-link">vroom</a></span><span class="op">(</span><span class="va">loanbook_csv</span>, show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">loanbook</span></span>
<span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' ### Check the edited dataset</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' Manual work is prone to errors. Check the edited dataset to ensure it's correct:</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' - Use `report_no_matches()` to explore companies in the loanbook that didn't match</span></span>
<span><span class="co">#' any company in the tilt dataset.</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">## -----------------------------------------------------------------------------</span></span>
<span><span class="va">not_matched</span> <span class="op">&lt;-</span> <span class="va">loanbook</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/report_no_matches.html">report_no_matches</a></span><span class="op">(</span><span class="va">edited</span><span class="op">)</span></span>
<span><span class="va">not_matched</span></span>
<span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' - Use `check_duplicated_relation()` to check if a company</span></span>
<span><span class="co">#' from loanbook has been matched to more than one company from the tilt dataset or</span></span>
<span><span class="co">#' reverse.</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">## -----------------------------------------------------------------------------</span></span>
<span><span class="co"># Good</span></span>
<span><span class="va">edited</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="../reference/check_duplicated_relation.html">check_duplicated_relation</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' With bad data you get informative errors.</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">## -----------------------------------------------------------------------------</span></span>
<span><span class="co"># Bad: A single loanbook-company can't match multiple tilt-companies</span></span>
<span><span class="va">bad_edited</span> <span class="op">&lt;-</span> <span class="va">edited</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>accept_match <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="cn">TRUE</span>, <span class="va">accept_match</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">bad_edited</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bad_edited</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/check_duplicated_relation.html">check_duplicated_relation</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Bad: Multiple loanbook-companies can't match a single tilt-company</span></span>
<span><span class="va">bad_edited2</span> <span class="op">&lt;-</span> <span class="va">demo_matched</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">id_tilt</span> <span class="op">==</span> <span class="fl">3</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fl">12</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">demo_matched</span><span class="op">)</span></span>
<span><span class="va">bad_edited2</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">accept_match</span> <span class="op">==</span> <span class="cn">TRUE</span> <span class="op">&amp;</span> <span class="va">id_tilt</span> <span class="op">==</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="va">bad_edited2</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/check_duplicated_relation.html">check_duplicated_relation</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' If your edited dataset is wrong, go back to your spreadsheet editor (i.e. repeat step 2), fix it, then check it again (i.e. repeat step 3).</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' ### Pick the matching companies</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' Once your edited dataset is correct, pick the matching companies and you're</span></span>
<span><span class="co">#' done. Your final dataset will have as many rows as the number of `TRUE` values</span></span>
<span><span class="co">#' in the `accept_match` columns of your edited dataset.</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">## -----------------------------------------------------------------------------</span></span>
<span><span class="va">edited</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">accept_match</span><span class="op">)</span></span>
<span></span>
<span><span class="va">final</span> <span class="op">&lt;-</span> <span class="va">edited</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">accept_match</span><span class="op">)</span></span>
<span><span class="va">final</span></span>
<span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' If you need to use your final dataset elsewhere, you may write it to a .csv file</span></span>
<span><span class="co">#' like before with:</span></span>
<span><span class="co">#' </span></span>
<span><span class="co">#' ```r</span></span>
<span><span class="co">#' final %&gt;% vroom::vroom_write("final.csv", delim = ",")</span></span>
<span><span class="co">#' ```</span></span></code></pre>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Mirja Hollmann, Linda Delacombaz, 2 Degrees Investing Initiative.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
