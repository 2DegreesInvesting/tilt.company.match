---
title: "tilt.company.match"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  cache = TRUE,
  collapse = TRUE,
  comment = "#>"
)
```

This document explains how to match companies in a loanbook from a bank to
companies in a tilt dataset from 2 Degrees Investing Initiative.

## Considerations

* The company's name may be different in each dataset, for example because of typos.
* The company's country and postcode are useful. A match by name, country, and postcode is more
reliable than a match by name alone.
* The company may not exist in the tilt dataset.

## System requirements

* [Install R and RStudio](https://happygitwithr.com/install-r-rstudio.html).
* [Setup an R build toolchain](https://r-pkgs.org/setup.html#setup-tools).

## 1. In R (session 1)

In this first R session you'll create a dataset with candidate matches for the
companies in your loanbook.

### Install tilt.company.match

You can install
[tilt.company.match](https://github.com/2DegreesInvesting/tilt.company.match)
from [r-universe](https://r-universe.dev/) with:

```r
options(repos = c("https://2degreesinvesting.r-universe.dev", getOption("repos")))
install.packages("tilt.company.match")
```

Or you can install it from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("2DegreesInvesting/tilt.company.match")
```

Call this function if things seem weird and you're not sure what's wrong or how
to fix it.

```r
devtools::dev_sitrep()
```

### Use R packages

Installing tilt.company.match should automatically install other useful packages. You can use them all with:

```{r}
library(dplyr, warn.conflicts = FALSE)
library(vroom, warn.conflicts = FALSE)
library(stringdist)
library(tilt.company.match)
```

### Read the datasets

This example uses "demo" datasets. You should use your real `loanbook` and `tilt` datasets instead.

```{r}
# TODO: Replace with the path/to/your/real/loanbook.csv
loanbook_csv <- example_file("demo_loanbook.csv")
loanbook_csv

loanbook <- vroom(loanbook_csv, show_col_types = FALSE)
loanbook

# TODO: Replace with the path/to/your/real/tilt.csv
tilt_csv <- example_file("demo_tilt.csv")
tilt_csv

tilt <- vroom(tilt_csv, show_col_types = FALSE)
tilt
```

### Check data quality

Both your loanbook and tilt dataset must meet these requirements:

* It's an R dataframe.
* It has the columns `id`, `company_name`, `postcode`, and `country`.
* It may or may not have other columns.
* The column `id` holds unique row-identifiers.

We check the `tilt` dataset and you should check your `loanbook`. For details
see `?check_loanbook()`.

```{r}
check_loanbook(loanbook)
```

### Suggest matches

Suggest matching companies between your `loanbook` and `tilt` datasets. For
details see `?suggest_match()`.

```{r}
to_edit <- suggest_match(loanbook, tilt)
to_edit
```

Write `to_edit` as a .csv file so that you can explore it in a spreadsheet
editor like Excel or GoogleSheets.

```r
vroom::vroom_write(to_edit, "to_edit.csv", delim = ",")
```

## 2. In a spreadsheet editor

### Accept or reject matches

* Import the dataset `to_edit` into a spreadsheet editor like Excel or GoogleSheets.
* For each row decide if you want to reject or accept the suggested match. By default
each row is rejected. To accept it type TRUE in the column `accept_match`.
* Save the edited file to later use it again in R, for example e.g. as "edited.csv".

## 3. In R (session 2)

### Use R packages and read data 

Restart R to ensure nothing from the previous R session affects this one.

Use the required packages for this section.

```{r}
library(dplyr, warn.conflicts = FALSE)
library(tilt.company.match)
```

Read the "edited.csv" file, and again your loanbook.

```{r}
# TODO: Replace with the path/to/your/real/edited.csv
edited_csv <- example_file("demo_matched.csv")
edited_csv

edited <- vroom(edited_csv, show_col_types = FALSE)
edited

# TODO: Replace with the path/to/your/real/loanbook.csv
loanbook_csv <- example_file("demo_loanbook.csv")
loanbook_csv

loanbook <- vroom(loanbook_csv, show_col_types = FALSE)
loanbook
```

### Check the edited dataset

Manual work is prone to errors. Check the edited dataset to ensure it's correct:

- Use `report_no_matches()` to explore companies in the loanbook that didn't match
any company in the tilt dataset.

```{r}
not_matched <- loanbook %>% report_no_matches(edited)
not_matched
```

- Use `check_duplicated_relation()` to check if a company
from loanbook has been matched to more than one company from the tilt dataset or
reverse.

```{r}
# Good
edited %>% check_duplicated_relation()
```

With bad data you get informative errors.

```{r}
# Bad: A single loanbook-company can't match multiple tilt-companies
bad_edited <- edited %>%
  mutate(accept_match = if_else(id %in% c(1, 2), TRUE, accept_match))
bad_edited %>% filter(id %in% c(1, 2))

bad_edited %>%
  check_duplicated_relation() %>%
  try()

# Bad: Multiple loanbook-companies can't match a single tilt-company
bad_edited2 <- demo_matched %>%
  filter(id_tilt == 3) %>%
  mutate(id = 12) %>%
  bind_rows(demo_matched)
bad_edited2 %>%
  filter(accept_match == TRUE & id_tilt == 3)

bad_edited2 %>%
  check_duplicated_relation() %>%
  try()
```

If your edited dataset is wrong, go back to your spreadsheet editor (i.e. repeat step 2), fix it, then check it again (i.e. repeat step 3).

### Pick the matching companies

Once your edited dataset is correct, pick the matching companies and you're
done. Your final dataset will have as many rows as the number of `TRUE` values
in the `accept_match` columns of your edited dataset.

```{r}
edited %>% count(accept_match)

final <- edited %>% filter(accept_match)
final
```

If you need to use your final dataset elsewhere, you may write it to a .csv file
like before with:

```r
final %>% vroom::vroom_write("final.csv", delim = ",")
```
